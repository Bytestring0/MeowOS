# 主题配置详解

完整的主题系统配置和自定义指南。

## 主题系统架构

MeowOS使用CSS变量驱动的主题系统，支持动态切换和用户自定义。

### 核心CSS变量

系统定义了以下CSS变量，所有组件都应使用这些变量：

```css
:root {
  /* 主色调 */
  --primary-color: #1976d2;
  --primary-variant-color: #1565c0;
  --on-primary-color: #ffffff;

  /* 次要色调 */
  --secondary-color: #03dac6;
  --secondary-variant-color: #018786;
  --on-secondary-color: #000000;

  /* 表面颜色 */
  --surface-color: #ffffff;
  --surface-variant-color: #f5f5f5;
  --on-surface-color: #000000;
  --on-surface-variant-color: #757575;

  /* 背景颜色 */
  --background-color: #fafafa;
  --on-background-color: #000000;

  /* 错误色调 */
  --error-color: #b00020;
  --on-error-color: #ffffff;

  /* 边框和分割线 */
  --outline-color: #e0e0e0;
  --outline-variant-color: #bdbdbd;

  /* 阴影 */
  --shadow-color: rgba(0, 0, 0, 0.2);
  --elevation-1: 0 2px 4px var(--shadow-color);
  --elevation-2: 0 4px 8px var(--shadow-color);
  --elevation-3: 0 8px 16px var(--shadow-color);

  /* 过渡动画 */
  --transition-fast: 0.2s ease;
  --transition-medium: 0.3s ease;
  --transition-slow: 0.5s ease;

  /* 字体 */
  --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
  --font-size-small: 0.875rem;
  --font-size-medium: 1rem;
  --font-size-large: 1.25rem;
  --font-size-xlarge: 1.5rem;

  /* 圆角 */
  --border-radius-small: 4px;
  --border-radius-medium: 8px;
  --border-radius-large: 16px;

  /* 间距 */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;
}
```

## 内置主题

### 默认主题

```css
/* themes/default.css */
:root {
  --primary-color: #1976d2;
  --surface-color: #ffffff;
  --background-color: #fafafa;
  --on-surface-color: #000000;
  /* ... 其他变量 */
}
```

### 深色主题

```css
/* themes/dark.css */
:root {
  --primary-color: #bb86fc;
  --surface-color: #1e1e1e;
  --background-color: #121212;
  --on-surface-color: #ffffff;
  --outline-color: #333333;
  --shadow-color: rgba(0, 0, 0, 0.5);
}
```

### 高对比度主题

```css
/* themes/high-contrast.css */
:root {
  --primary-color: #ffffff;
  --surface-color: #000000;
  --background-color: #000000;
  --on-surface-color: #ffffff;
  --outline-color: #ffffff;
  --error-color: #ff0000;
}
```

## 主题定义结构

### ThemeDefinition接口

```typescript
interface ThemeDefinition {
  id: string;                    // 主题唯一标识
  name: string;                  // 显示名称
  description?: string;          // 描述
  author?: string;               // 作者
  version?: string;              // 版本
  preview?: string;              // 预览图
  colors: ThemeColors;           // 颜色配置
  properties?: ThemeProperties;  // 扩展属性
}

interface ThemeColors {
  primary: string;
  primaryVariant?: string;
  onPrimary: string;
  secondary: string;
  secondaryVariant?: string;
  onSecondary: string;
  surface: string;
  surfaceVariant?: string;
  onSurface: string;
  onSurfaceVariant?: string;
  background: string;
  onBackground: string;
  error: string;
  onError: string;
  outline: string;
  outlineVariant?: string;
  shadow?: string;
}

interface ThemeProperties {
  borderRadius?: {
    small: string;
    medium: string;
    large: string;
  };
  spacing?: {
    xs: string;
    sm: string;
    md: string;
    lg: string;
    xl: string;
  };
  elevation?: {
    low: string;
    medium: string;
    high: string;
  };
  transitions?: {
    fast: string;
    medium: string;
    slow: string;
  };
}
```

## 创建自定义主题

### 1. 基础主题创建

```typescript
// 创建主题定义
const myTheme: ThemeDefinition = {
  id: 'cyberpunk',
  name: '赛博朋克',
  description: '未来科幻风格主题',
  author: 'MeowOS Team',
  version: '1.0.0',
  colors: {
    primary: '#00ff9f',
    onPrimary: '#000000',
    secondary: '#ff0080',
    onSecondary: '#ffffff',
    surface: '#0a0a0a',
    surfaceVariant: '#1a1a1a',
    onSurface: '#00ff9f',
    onSurfaceVariant: '#80ff80',
    background: '#000000',
    onBackground: '#00ff9f',
    error: '#ff0040',
    onError: '#ffffff',
    outline: '#008060',
    outlineVariant: '#004030',
    shadow: 'rgba(0, 255, 159, 0.3)'
  },
  properties: {
    borderRadius: {
      small: '2px',
      medium: '4px',
      large: '8px'
    },
    elevation: {
      low: '0 0 10px rgba(0, 255, 159, 0.2)',
      medium: '0 0 20px rgba(0, 255, 159, 0.3)',
      high: '0 0 30px rgba(0, 255, 159, 0.5)'
    }
  }
}
```

### 2. 注册主题

```typescript
// 在应用初始化时注册主题
import { system } from '@/core/api'

const registerCustomTheme = async () => {
  // 添加主题到系统
  system.themes.push(myTheme)
  
  // 如果需要持久化
  await storage.setSystemSetting('custom-themes', system.themes.filter(t => 
    !['default', 'dark', 'high-contrast'].includes(t.id)
  ))
}
```

### 3. 动态生成CSS

```typescript
// 主题应用函数
const applyTheme = (theme: ThemeDefinition) => {
  const root = document.documentElement
  
  // 应用颜色
  Object.entries(theme.colors).forEach(([key, value]) => {
    const cssVar = `--${key.replace(/([A-Z])/g, '-$1').toLowerCase()}-color`
    root.style.setProperty(cssVar, value)
  })
  
  // 应用其他属性
  if (theme.properties) {
    if (theme.properties.borderRadius) {
      Object.entries(theme.properties.borderRadius).forEach(([key, value]) => {
        root.style.setProperty(`--border-radius-${key}`, value)
      })
    }
    
    if (theme.properties.elevation) {
      Object.entries(theme.properties.elevation).forEach(([key, value]) => {
        root.style.setProperty(`--elevation-${key}`, value)
      })
    }
  }
}
```

## 主题管理器

### 自定义主题管理器组件

```vue
<template>
  <div class="theme-manager">
    <h3>主题设置</h3>
    
    <!-- 内置主题 -->
    <div class="theme-section">
      <h4>内置主题</h4>
      <div class="theme-grid">
        <div v-for="theme in builtinThemes" 
             :key="theme.id"
             class="theme-card"
             :class="{ active: currentTheme === theme.id }"
             @click="setTheme(theme.id)">
          <div class="theme-preview" :style="getPreviewStyle(theme)"></div>
          <div class="theme-info">
            <div class="theme-name">{{ theme.name }}</div>
            <div class="theme-desc">{{ theme.description }}</div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- 自定义主题 -->
    <div class="theme-section">
      <h4>自定义主题</h4>
      <div class="theme-grid">
        <div v-for="theme in customThemes" 
             :key="theme.id"
             class="theme-card"
             :class="{ active: currentTheme === theme.id }">
          <div class="theme-preview" :style="getPreviewStyle(theme)"></div>
          <div class="theme-info">
            <div class="theme-name">{{ theme.name }}</div>
            <div class="theme-actions">
              <button @click="setTheme(theme.id)">应用</button>
              <button @click="editTheme(theme)">编辑</button>
              <button @click="deleteTheme(theme.id)">删除</button>
            </div>
          </div>
        </div>
        
        <!-- 创建新主题 -->
        <div class="theme-card create-new" @click="createNewTheme">
          <div class="create-icon">+</div>
          <div class="create-text">创建主题</div>
        </div>
      </div>
    </div>
    
    <!-- 主题编辑器 -->
    <ThemeEditor v-if="showEditor" 
                 :theme="editingTheme"
                 @save="saveTheme"
                 @cancel="showEditor = false" />
  </div>
</template>

<script setup>
import { ref, computed, onMounted } from 'vue'
import { system, storage } from '@/core/api'
import ThemeEditor from './ThemeEditor.vue'

const currentTheme = ref(system.theme)
const customThemes = ref([])
const showEditor = ref(false)
const editingTheme = ref(null)

const builtinThemes = computed(() => 
  system.themes.filter(t => ['default', 'dark', 'high-contrast'].includes(t.id))
)

const setTheme = async (themeId) => {
  await system.setTheme(themeId)
  currentTheme.value = themeId
}

const getPreviewStyle = (theme) => ({
  background: `linear-gradient(135deg, ${theme.colors.primary}, ${theme.colors.secondary})`,
  color: theme.colors.onPrimary
})

const createNewTheme = () => {
  editingTheme.value = {
    id: '',
    name: '新主题',
    colors: { ...system.themes[0].colors }
  }
  showEditor.value = true
}

const editTheme = (theme) => {
  editingTheme.value = { ...theme }
  showEditor.value = true
}

const saveTheme = async (theme) => {
  const existingIndex = customThemes.value.findIndex(t => t.id === theme.id)
  if (existingIndex >= 0) {
    customThemes.value[existingIndex] = theme
  } else {
    customThemes.value.push(theme)
  }
  
  await storage.setSystemSetting('custom-themes', customThemes.value)
  showEditor.value = false
}

const deleteTheme = async (themeId) => {
  customThemes.value = customThemes.value.filter(t => t.id !== themeId)
  await storage.setSystemSetting('custom-themes', customThemes.value)
}

onMounted(async () => {
  const saved = await storage.getSystemSetting('custom-themes')
  if (saved) customThemes.value = saved
})
</script>

<style scoped>
.theme-manager {
  padding: 20px;
  max-width: 800px;
}

.theme-section {
  margin-bottom: 30px;
}

.theme-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
  gap: 16px;
  margin-top: 16px;
}

.theme-card {
  border: 2px solid var(--outline-color);
  border-radius: var(--border-radius-medium);
  overflow: hidden;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.theme-card:hover {
  border-color: var(--primary-color);
  transform: translateY(-2px);
}

.theme-card.active {
  border-color: var(--primary-color);
  box-shadow: var(--elevation-2);
}

.theme-preview {
  height: 80px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
}

.theme-info {
  padding: 12px;
  background: var(--surface-color);
}

.theme-name {
  font-weight: 600;
  margin-bottom: 4px;
}

.theme-desc {
  font-size: var(--font-size-small);
  color: var(--on-surface-variant-color);
}

.theme-actions {
  display: flex;
  gap: 8px;
  margin-top: 8px;
}

.theme-actions button {
  flex: 1;
  padding: 4px 8px;
  border: 1px solid var(--outline-color);
  border-radius: var(--border-radius-small);
  background: var(--surface-variant-color);
  cursor: pointer;
  font-size: var(--font-size-small);
}

.create-new {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 140px;
  border-style: dashed;
  color: var(--on-surface-variant-color);
}

.create-icon {
  font-size: 2rem;
  margin-bottom: 8px;
}
</style>
```

## 主题切换动画

### 平滑过渡效果

```css
/* 为所有使用主题变量的元素添加过渡 */
* {
  transition: 
    background-color var(--transition-medium),
    color var(--transition-medium),
    border-color var(--transition-medium),
    box-shadow var(--transition-medium);
}

/* 特殊元素的过渡处理 */
.window {
  transition: all var(--transition-medium);
}

.button {
  transition: 
    background-color var(--transition-fast),
    transform var(--transition-fast);
}
```

### 主题切换钩子

```typescript
// 主题切换时的生命周期钩子
export class ThemeManager {
  private beforeThemeChange?: () => void
  private afterThemeChange?: (themeId: string) => void

  async setTheme(themeId: string) {
    // 切换前回调
    this.beforeThemeChange?.()
    
    // 应用主题
    const theme = this.themes.find(t => t.id === themeId)
    if (theme) {
      this.applyTheme(theme)
      
      // 保存设置
      await storage.setSystemSetting('theme', themeId)
      
      // 发送事件
      eventBus.emit(SystemEvents.ThemeChanged, themeId)
      
      // 切换后回调
      this.afterThemeChange?.(themeId)
    }
  }

  onBeforeThemeChange(callback: () => void) {
    this.beforeThemeChange = callback
  }

  onAfterThemeChange(callback: (themeId: string) => void) {
    this.afterThemeChange = callback
  }
}
```

## 响应式主题

### 自动深色模式

```typescript
// 根据系统设置自动切换主题
const setupAutoTheme = () => {
  const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)')
  
  const updateTheme = (e: MediaQueryListEvent) => {
    const prefersDark = e.matches
    const autoTheme = prefersDark ? 'dark' : 'default'
    
    // 只在用户设置为自动时切换
    const userSetting = getUserConfig().theme
    if (userSetting === 'auto') {
      system.applyTheme(autoTheme)
    }
  }
  
  mediaQuery.addEventListener('change', updateTheme)
  
  // 初始检查
  updateTheme({ matches: mediaQuery.matches } as MediaQueryListEvent)
}
```

### 时间基础主题

```typescript
// 根据时间自动切换主题
const setupTimeBasedTheme = () => {
  const updateThemeByTime = () => {
    const hour = new Date().getHours()
    
    let themeId: string
    if (hour >= 6 && hour < 18) {
      themeId = 'default'  // 白天主题
    } else if (hour >= 18 && hour < 22) {
      themeId = 'warm'     // 暖色主题
    } else {
      themeId = 'dark'     // 深色主题
    }
    
    const userSetting = getUserConfig().themeMode
    if (userSetting === 'time-based') {
      system.applyTheme(themeId)
    }
  }
  
  // 每小时检查一次
  setInterval(updateThemeByTime, 60 * 60 * 1000)
  updateThemeByTime()
}
```

## 主题导入导出

### 导出主题

```typescript
const exportTheme = (themeId: string): string => {
  const theme = system.themes.find(t => t.id === themeId)
  if (!theme) throw new Error('主题不存在')
  
  return JSON.stringify({
    ...theme,
    exportedAt: new Date().toISOString(),
    exportVersion: '1.0.0'
  }, null, 2)
}

// 下载主题文件
const downloadTheme = (themeId: string) => {
  const themeData = exportTheme(themeId)
  const blob = new Blob([themeData], { type: 'application/json' })
  const url = URL.createObjectURL(blob)
  
  const a = document.createElement('a')
  a.href = url
  a.download = `${themeId}-theme.json`
  a.click()
  
  URL.revokeObjectURL(url)
}
```

### 导入主题

```typescript
const importTheme = (file: File): Promise<ThemeDefinition> => {
  return new Promise((resolve, reject) => {
    const reader = new FileReader()
    
    reader.onload = (e) => {
      try {
        const themeData = JSON.parse(e.target?.result as string)
        
        // 验证主题格式
        if (!validateThemeFormat(themeData)) {
          reject(new Error('主题格式不正确'))
          return
        }
        
        // 确保唯一ID
        if (system.themes.some(t => t.id === themeData.id)) {
          themeData.id = `${themeData.id}-imported-${Date.now()}`
        }
        
        resolve(themeData)
      } catch (error) {
        reject(new Error('主题文件解析失败'))
      }
    }
    
    reader.onerror = () => reject(new Error('文件读取失败'))
    reader.readAsText(file)
  })
}

const validateThemeFormat = (theme: any): boolean => {
  const requiredFields = ['id', 'name', 'colors']
  const requiredColors = ['primary', 'onPrimary', 'surface', 'onSurface', 'background', 'onBackground']
  
  return requiredFields.every(field => theme[field] !== undefined) &&
         requiredColors.every(color => theme.colors[color] !== undefined)
}
```

## 主题最佳实践

### 1. 颜色对比度

确保文本和背景有足够的对比度：

```typescript
// 计算颜色对比度
const getContrast = (color1: string, color2: string): number => {
  const l1 = getLuminance(color1)
  const l2 = getLuminance(color2)
  return (Math.max(l1, l2) + 0.05) / (Math.min(l1, l2) + 0.05)
}

// 验证主题可访问性
const validateThemeAccessibility = (theme: ThemeDefinition): string[] => {
  const issues: string[] = []
  
  if (getContrast(theme.colors.primary, theme.colors.onPrimary) < 4.5) {
    issues.push('主色调对比度不足')
  }
  
  if (getContrast(theme.colors.surface, theme.colors.onSurface) < 4.5) {
    issues.push('表面颜色对比度不足')
  }
  
  return issues
}
```

### 2. 语义化命名

使用语义化的颜色命名而非具体颜色：

```typescript
// 好的做法
const colors = {
  primary: '#1976d2',      // 主要操作色
  error: '#b00020',        // 错误状态色
  warning: '#f57c00',      // 警告状态色
  success: '#388e3c'       // 成功状态色
}

// 避免的做法
const colors = {
  blue: '#1976d2',
  red: '#b00020',
  orange: '#f57c00',
  green: '#388e3c'
}
```

### 3. 主题继承

支持基于现有主题创建新主题：

```typescript
const createDerivedTheme = (baseThemeId: string, overrides: Partial<ThemeColors>): ThemeDefinition => {
  const baseTheme = system.themes.find(t => t.id === baseThemeId)
  if (!baseTheme) throw new Error('基础主题不存在')
  
  return {
    ...baseTheme,
    id: `${baseThemeId}-derived-${Date.now()}`,
    name: `${baseTheme.name} (自定义)`,
    colors: {
      ...baseTheme.colors,
      ...overrides
    }
  }
}
```

这份主题配置指南基于MeowOS的实际主题系统编写，涵盖了完整的主题开发流程。
